#!/usr/bin/env bash
set -e # fail on first error
set +x

# staging conf:
WISE_ENVIRONMENT_TYPE=staging
VAULT_DOMAIN="vault.staging.wise.vote"
VAULT_SUBJECT_TEXT="/subjectAltName=DNS:localhost,DNS:vault.staging.wise.vote,IP:0.0.0.0,IP:127.0.0.1,IP:51.38.133.176,IP:2001:41d0:0601:1100:0000:0000:0000:24cd"
# /subjectAltName=DNS.1=axway.lab,DNS.2=your-alt-name

DIR="/etc/vault/cert"
WISE_SUBJECT="/C=PL/ST=DOLNOSLASKIE/L=OLAWA/O=WiseVault"
CRTOUT_FILE="certificate.crt"
PRIVKEY_FILE="privateKey.key"

#source: https://community.axway.com/s/feed/0D52X000065Ykx2SAC
# Mkdir
mkdir -p "${DIR}"
cd "${DIR}"


cat > "${DIR}/certgen.staging.conf" <<- EOM
[dn]
CN=vault.staging.wise.vote
[req]
distinguished_name = dn
[EXT]
subjectAltName=@alt_names
keyUsage=digitalSignature
extendedKeyUsage=serverAuth
[alt_names]
DNS.1 = localhost
DNS.2 = vault.staging.wise.vote
IP.1  = 0.0.0.0
IP.2  = 127.0.0.1
IP.3  = 51.38.133.176
IP.4  = 2001:41d0:0601:1100:0000:0000:0000:24cd
EOM

cat > "${DIR}/certgen.production.conf" <<- EOM
[dn]
[req]
distinguished_name = dn
[EXT]
subjectAltName=@alt_names
keyUsage=digitalSignature
extendedKeyUsage=serverAuth
[alt_names]
DNS.1 = localhost
DNS.2 = vault.wise.vote
IP.1  = 0.0.0.0
IP.2  = 127.0.0.1
IP.3  = 51.38.98.112
IP.4  = 2001:41d0:0701:1100:0000:0000:0000:1381
EOM

# Generate CA
openssl genrsa -out CA.key 2048
openssl req -new -sha256 -key CA.key -out CA.csr -subj "${WISE_SUBJECT}/CN=CA CERTIFICATE"
openssl x509 -signkey CA.key -in CA.csr -req -days 3650 -out CA.pem
openssl x509 -outform der -in CA.pem -out CA.crt

# Generate intermediary
openssl genrsa -out CA_Intermediary.key 2048
openssl req -new -sha256 -key CA_Intermediary.key -out CA_Intermediary.csr \
    -subj "${WISE_SUBJECT}/CN=CA INTERMEDIARY CERTIFICATE"

openssl x509 -req -in CA_Intermediary.csr -CA CA.pem -CAkey CA.key -CAcreateserial -out CA_Intermediary.crt \
   -days 3650 -sha256


# Generate server cert signed by CA
openssl genrsa -out ServerCert_signedByCA.key 2048

openssl req -new -sha256 -key ServerCert_signedByCA.key -out ServerCert_signedByCA.csr \
    -extensions EXT -config /etc/vault/cert/certgen.${WISE_ENVIRONMENT_TYPE}.conf
    #-subj "/CN=${VAULT_DOMAIN}" \
     #-subj "${WISE_SUBJECT}/CN=${VAULT_DOMAIN}${VAULT_SUBJECT_TEXT}"

openssl x509 -req -in ServerCert_signedByCA.csr -CA CA.pem -CAkey CA.key -CAcreateserial -out ServerCert_signedByCA.crt -days 3650 -sha256

#openssl req -x509 -out ServerCert_signedByCA.crt -key ServerCert_signedByCA.key \
#  -nodes -sha256 -CA CA.pem -CAkey CA.key -CAcreateserial \
#  -days 3650 \
#  -subj "/CN=${VAULT_DOMAIN}" -extensions EXT -config "${DIR}/certgen.${WISE_ENVIRONMENT_TYPE}.conf"

#openssl req -new -sha256 -key ServerCert_signedByCA.key -out ServerCert_signedByCA.csr \
#    -subj "${WISE_SUBJECT}/CN=${VAULT_DOMAIN}" \
#    -extensions EXT -config="${DIR}/certgen.${WISE_ENVIRONMENT_TYPE}.conf"

#openssl x509 -req -in ServerCert_signedByCA.csr -CA CA.pem -CAkey CA.key -CAcreateserial \
#    -out ServerCert_signedByCA.crt -days 3650 \
#    -subj "${WISE_SUBJECT}/CN=${VAULT_DOMAIN}" \
#    -extensions EXT -config="${DIR}/certgen.${WISE_ENVIRONMENT_TYPE}.conf" \
#    -sha256

#openssl x509 -text -noout -in ServerCert_signedByCA.crt

cp ServerCert_signedByCA.crt "${DIR}/${CRTOUT_FILE}"
cp ServerCert_signedByCA.key "${DIR}/${PRIVKEY_FILE}"

chmod -R 750 "${DIR}"
chown -R vault:vault "${DIR}"

# Generate Server Certificate signed by Intermediary CA
#openssl genrsa -out ServerCert_signedByCAIntermediary.key 2048

#openssl req -new -sha256 -key ServerCert_signedByCAIntermediary.key \
#    -out ServerCert_signedByCAIntermediary.csr \
#    -extensions EXT  -config="${DIR}/certgen.${WISE_ENVIRONMENT_TYPE}.conf"

#openssl x509 -req -in ServerCert_signedByCAIntermediary.csr -CA CA.pem -CAkey CA.key -CAcreateserial \
#   -out ServerCert_signedByCAIntermediary.crt -days 3650 -sha256

#openssl x509 -text -noout -in ServerCert_signedByCAIntermediary.crt

# Old cert gen:
#openssl req -x509 -out /etc/vault/cert/certificate.crt -keyout /etc/vault/cert/privateKey.key \
#  -newkey rsa:2048 -nodes -sha256 \
#  -days 730 \
#  -subj "/CN=vault.wise.vote" -extensions EXT -config /etc/vault/cert/certgen.conf